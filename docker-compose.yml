version: '3.8'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: echo srvr | nc localhost 2181 || exit 1
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    healthcheck:
      test: nc -z localhost 9092 || exit 1
      interval: 10s
      timeout: 5s
      retries: 5

  mongo:
    image: mongo:6.0
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7.0-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  user-service:
    build: ./services/user-service
    container_name: user-service
    ports:
      - "4001:4001"
    environment:
      - PORT=4001
      - MONGO_URI=mongodb://mongo:27017/collabspace_users
      - JWT_SECRET=change_this_secret
      - JWT_EXPIRES_IN=7d
      - BCRYPT_SALT_ROUNDS=10
    depends_on:
      mongo:
        condition: service_healthy
    restart: always

  document-service:
    build: ./services/document-service
    container_name: document-service
    ports:
      - "4002:4002"
    environment:
      - PORT=4002
      - MONGO_URI=mongodb://mongo:27017/collabspace_documents
      - JWT_SECRET=change_this_secret
      - SHARE_TOKEN_SECRET=share_secret
      - SHARE_LINK_EXPIRES_IN=7d
      - USER_SERVICE_URL=http://user-service:4001
    depends_on:
      mongo:
        condition: service_healthy
      user-service:
        condition: service_started
    restart: always

  collaboration-service:
    build: ./services/collaboration-service
    container_name: collaboration-service
    ports:
      - "4003:4003"
    environment:
      - PORT=4003
      - MONGO_URI=mongodb://mongo:27017/collabspace_collab
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKERS=kafka:9092
      - KAFKA_CLIENT_ID=collab-service
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: always

  version-service:
    build: ./services/version-service
    container_name: version-service
    ports:
      - "4004:4004"
    environment:
      - PORT=4004
      - MONGO_URI=mongodb://mongo:27017/collabspace_versions
      - KAFKA_BROKERS=kafka:9092
      - COLLABORATION_SERVICE_URL=http://collaboration-service:4003
    depends_on:
      mongo:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: always

  notification-service:
    build: ./services/notification-service
    container_name: notification-service
    ports:
      - "4005:4005"
    environment:
      - PORT=4005
      - MONGO_URI=mongodb://mongo:27017/collabspace_notifications
      - KAFKA_BROKERS=kafka:9092
      - KAFKA_CLIENT_ID=notification-service
      - KAFKA_GROUP_ID=notification-consumer
      - SMTP_HOST=smtp.example.com
      - SMTP_PORT=587
      - SMTP_USER=user
      - SMTP_PASS=pass
      - FROM_EMAIL=no-reply@collabspace.local
      - USER_SERVICE_URL=http://user-service:4001
      - LOG_LEVEL=info
    depends_on:
      mongo:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: always

  comment-service:
    build: ./services/comment-service
    container_name: comment-service
    ports:
      - "4006:4006"
    environment:
      - PORT=4006
      - MONGO_URI=mongodb://mongo:27017/collabspace_comments
      - KAFKA_BROKERS=kafka:9092
      - USER_SERVICE_URL=http://user-service:4001
    depends_on:
      mongo:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: always

  gateway-service:
    build: ./services/gateway-service
    container_name: gateway-service
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - USER_SERVICE_URL=http://user-service:4001
      - DOC_SERVICE_URL=http://document-service:4002
      - COLLAB_SERVICE_URL=http://collaboration-service:4003
      - VERSION_SERVICE_URL=http://version-service:4004
      - NOTIF_SERVICE_URL=http://notification-service:4005
      - COMMENT_SERVICE_URL=http://comment-service:4006
    depends_on:
      user-service:
        condition: service_started
      document-service:
        condition: service_started
      collaboration-service:
        condition: service_started
      version-service:
        condition: service_started
      notification-service:
        condition: service_started
      comment-service:
        condition: service_started
    restart: always

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      gateway-service:
        condition: service_started
      collaboration-service:
        condition: service_started
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/nginx-health" ]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: always

volumes:
  mongo_data:
  nginx_logs:
